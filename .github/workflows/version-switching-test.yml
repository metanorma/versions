name: Version Switching Tests

on:
  push:
    branches: [main, test-gha-workflows]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

env:
  VERSIONS: '1.13.9 1.14.3'
  SAMPLES_REPO: 'metanorma/mn-samples-cc'
  SAMPLES_REF: 'main'

jobs:
  version-switching:
    name: Version Switching (gemfile)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout mnenv
        uses: actions/checkout@v4
        with:
          path: mnenv

      - name: Checkout mn-samples-cc
        uses: actions/checkout@v4
        with:
          repository: ${{ env.SAMPLES_REPO }}
          ref: ${{ env.SAMPLES_REF }}
          path: samples

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'
          bundler-cache: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-liberation plantuml

      - name: Install mnenv
        working-directory: mnenv
        run: |
          bundle install
          rake install
          mnenv version

      - name: Install Metanorma versions
        run: |
          for version in ${{ env.VERSIONS }}; do
            echo "Installing Metanorma gemfile version: $version"
            mnenv install "$version" --source gemfile
          done
          mnenv versions

      - name: Verify shims created
        run: |
          ls -lah ~/.mnenv/shims/
          cat ~/.mnenv/shims/metanorma

      - name: Test global version switching
        run: |
          export PATH="$HOME/.mnenv/shims:$PATH"

          echo "=== Testing global version switching ==="

          # Set global to first version
          mnenv global 1.13.9 --source gemfile
          metanorma_version=$(metanorma --version 2>&1 | grep "Metanorma::Cli" | grep -oP '\d+\.\d+\.\d+' || echo "failed")
          echo "After setting global to 1.13.9: Metanorma::Cli version = $metanorma_version"
          if [ "$metanorma_version" = "1.13.9" ]; then
            echo "✓ Global version 1.13.9 verified"
          else
            echo "✗ Expected 1.13.9, got $metanorma_version"
            exit 1
          fi

          # Switch to second version
          mnenv global 1.14.3 --source gemfile
          metanorma_version=$(metanorma --version 2>&1 | grep "Metanorma::Cli" | grep -oP '\d+\.\d+\.\d+' || echo "failed")
          echo "After switching global to 1.14.3: Metanorma::Cli version = $metanorma_version"
          if [ "$metanorma_version" = "1.14.3" ]; then
            echo "✓ Global version 1.14.3 verified"
          else
            echo "✗ Expected 1.14.3, got $metanorma_version"
            exit 1
          fi

          echo "✓ Global version switching test passed"

      - name: Test local version override
        run: |
          export PATH="$HOME/.mnenv/shims:$PATH"

          echo "=== Testing local version override ==="

          # Set global to 1.14.3
          mnenv global 1.14.3 --source gemfile
          global_version=$(metanorma --version 2>&1 | grep "Metanorma::Cli" | grep -oP '\d+\.\d+\.\d+' || echo "failed")
          echo "Global version: $global_version"

          # Create test directory and set local version
          mkdir -p /tmp/test-project
          cd /tmp/test-project
          mnenv local 1.13.9 --source gemfile

          # Verify local override works
          local_version=$(metanorma --version 2>&1 | grep "Metanorma::Cli" | grep -oP '\d+\.\d+\.\d+' || echo "failed")
          echo "Local version in /tmp/test-project: $local_version"
          if [ "$local_version" = "1.13.9" ]; then
            echo "✓ Local version 1.13.9 overrides global 1.14.3"
          else
            echo "✗ Expected 1.13.9, got $local_version"
            exit 1
          fi

          # Verify global still applies outside local directory
          cd /tmp
          outside_version=$(metanorma --version 2>&1 | grep "Metanorma::Cli" | grep -oP '\d+\.\d+\.\d+' || echo "failed")
          echo "Version outside /tmp/test-project: $outside_version"
          if [ "$outside_version" = "1.14.3" ]; then
            echo "✓ Global version 1.14.3 restored outside project directory"
          else
            echo "✗ Expected 1.14.3, got $outside_version"
            exit 1
          fi

          echo "✓ Local version override test passed"

      - name: Test document compilation with version switching
        working-directory: samples
        run: |
          export PATH="$HOME/.mnenv/shims:$PATH"

          echo "=== Testing document compilation with version switching ==="

          # Test with version 1.13.9
          mnenv global 1.13.9 --source gemfile
          echo "Compiling with version 1.13.9..."
          metanorma compile sources/cc-18011.adoc
          if [ -f "sources/cc-18011.xml" ]; then
            echo "✓ Document compiled with 1.13.9"
            rm -f sources/cc-18011.xml sources/cc-18011.html
          else
            echo "✗ Document compilation failed with 1.13.9"
            exit 1
          fi

          # Test with version 1.14.3
          mnenv global 1.14.3 --source gemfile
          echo "Compiling with version 1.14.3..."
          metanorma compile sources/cc-18011.adoc
          if [ -f "sources/cc-18011.xml" ]; then
            echo "✓ Document compiled with 1.14.3"
          else
            echo "✗ Document compilation failed with 1.14.3"
            exit 1
          fi

          echo "✓ Document compilation test passed"

      - name: Display final state
        if: always()
        run: |
          echo "=== Final mnenv state ==="
          export PATH="$HOME/.mnenv/shims:$PATH"

          echo "Installed versions:"
          mnenv versions

          echo ""
          echo "Global version:"
          cat ~/.mnenv/version 2>/dev/null || echo "Not set"

          echo ""
          echo "Global source:"
          cat ~/.mnenv/source 2>/dev/null || echo "Not set"
